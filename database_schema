-- Create Schema
IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = 'CW2')
BEGIN
    EXEC('CREATE SCHEMA CW2');
END
GO

-- Drop existing tables if they exist (in correct order due to foreign keys)
IF OBJECT_ID('CW2.Trail_Log', 'U') IS NOT NULL DROP TABLE CW2.Trail_Log;
IF OBJECT_ID('CW2.Trail_Feature', 'U') IS NOT NULL DROP TABLE CW2.Trail_Feature;
IF OBJECT_ID('CW2.Trail', 'U') IS NOT NULL DROP TABLE CW2.Trail;
IF OBJECT_ID('CW2.Feature', 'U') IS NOT NULL DROP TABLE CW2.Feature;
IF OBJECT_ID('CW2.Difficulty', 'U') IS NOT NULL DROP TABLE CW2.Difficulty;
IF OBJECT_ID('CW2.Route', 'U') IS NOT NULL DROP TABLE CW2.Route;
IF OBJECT_ID('CW2.Location', 'U') IS NOT NULL DROP TABLE CW2.Location;
IF OBJECT_ID('CW2.Users', 'U') IS NOT NULL DROP TABLE CW2.Users;
GO

-- Create Users Table
CREATE TABLE CW2.Users (
    user_id VARCHAR(7) PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL CHECK (role IN ('admin', 'user'))
);

-- Create Location Table
CREATE TABLE CW2.Location (
    location_id VARCHAR(7) PRIMARY KEY,
    location_name VARCHAR(100) NOT NULL,
    region VARCHAR(100),
    country VARCHAR(50)
);

-- Create Route Table
CREATE TABLE CW2.Route (
    route_id VARCHAR(7) PRIMARY KEY,
    route_type VARCHAR(50) NOT NULL CHECK (route_type IN ('loop', 'out-and-back', 'point-to-point'))
);

-- Create Difficulty Table
CREATE TABLE CW2.Difficulty (
    difficulty_id VARCHAR(7) PRIMARY KEY,
    level VARCHAR(20) NOT NULL CHECK (level IN ('easy', 'moderate', 'hard', 'strenuous'))
);

-- Create Feature Table
CREATE TABLE CW2.Feature (
    feature_id VARCHAR(7) PRIMARY KEY,
    feature_name VARCHAR(100) NOT NULL
);

-- Create Trail Table
CREATE TABLE CW2.Trail (
    trail_id VARCHAR(7) PRIMARY KEY,
    trail_name VARCHAR(100) NOT NULL,
    description VARCHAR(MAX),  -- CHANGED FROM TEXT TO VARCHAR(MAX)
    visibility VARCHAR(20) NOT NULL CHECK (visibility IN ('full', 'limited')),
    created_at DATETIME NOT NULL DEFAULT GETDATE(),
    updated_at DATETIME NOT NULL DEFAULT GETDATE(),
    location_id VARCHAR(7) FOREIGN KEY REFERENCES CW2.Location(location_id),
    length DECIMAL(5,2),
    estimated_time DECIMAL(4,2),
    elevation_gain INT,
    route_id VARCHAR(7) NOT NULL FOREIGN KEY REFERENCES CW2.Route(route_id),
    difficulty_id VARCHAR(7) NOT NULL FOREIGN KEY REFERENCES CW2.Difficulty(difficulty_id),
    created_by VARCHAR(7) FOREIGN KEY REFERENCES CW2.Users(user_id)
);

-- Create Trail_Feature Junction Table
CREATE TABLE CW2.Trail_Feature (
    trail_feature_id VARCHAR(8) PRIMARY KEY,
    trail_id VARCHAR(7) NOT NULL FOREIGN KEY REFERENCES CW2.Trail(trail_id) ON DELETE CASCADE,
    feature_id VARCHAR(7) NOT NULL FOREIGN KEY REFERENCES CW2.Feature(feature_id)
);

-- Create Trail_Log Audit Table
CREATE TABLE CW2.Trail_Log (
    log_id INT IDENTITY(1,1) PRIMARY KEY,
    trail_id VARCHAR(7),
    trail_name VARCHAR(100),
    added_by VARCHAR(7),
    added_on DATETIME DEFAULT GETDATE()
);
GO

-- Create Trigger for Trail_Log
CREATE TRIGGER CW2.trg_Trail_Insert
ON CW2.Trail
AFTER INSERT
AS
BEGIN
    INSERT INTO CW2.Trail_Log (trail_id, trail_name, added_by, added_on)
    SELECT trail_id, trail_name, created_by, GETDATE()
    FROM inserted;
END
GO

-- Insert Sample Data

-- Users
INSERT INTO CW2.Users (user_id, username, email, password, role) VALUES
('U000001', 'Grace Hopper', 'grace@plymouth.ac.uk', 'ISAD123!', 'admin'),
('U000002', 'Tim Berners-Lee', 'tim@plymouth.ac.uk', 'COMP2001!', 'user'),
('U000003', 'Ada Lovelace', 'ada@plymouth.ac.uk', 'insecurePassword', 'user');

-- Locations
INSERT INTO CW2.Location (location_id, location_name, region, country) VALUES
('L000001', 'Plymouth Waterfront', 'Devon', 'England'),
('L000002', 'South Devon AONB', 'Devon', 'England'),
('L000003', 'Dartmoor', 'Devon', 'England');

-- Routes
INSERT INTO CW2.Route (route_id, route_type) VALUES
('R000001', 'loop'),
('R000002', 'out-and-back'),
('R000003', 'point-to-point');

-- Difficulties
INSERT INTO CW2.Difficulty (difficulty_id, level) VALUES
('D000001', 'easy'),
('D000002', 'moderate'),
('D000003', 'hard'),
('D000004', 'strenuous');

-- Features
INSERT INTO CW2.Feature (feature_id, feature_name) VALUES
('F000001', 'Beaches'),
('F000002', 'Waterfalls'),
('F000003', 'Wildlife'),
('F000004', 'Historic Sites'),
('F000005', 'Pub walks');

-- Trails
INSERT INTO CW2.Trail (trail_id, trail_name, description, visibility, location_id, length, estimated_time, elevation_gain, route_id, difficulty_id, created_by) VALUES
('T000001', 'Bovisand to Jennycliff', 'Coastal walk in South Devon AONB along stunning clifftops', 'full', 'L000002', 5.80, 2.00, 161, 'R000002', 'D000002', 'U000001'),
('T000002', 'Plymouth Waterfront Walk', 'Easy waterfront stroll through historic Barbican', 'full', 'L000001', 3.20, 1.50, 20, 'R000001', 'D000001', 'U000002');

-- Trail Features
INSERT INTO CW2.Trail_Feature (trail_feature_id, trail_id, feature_id) VALUES
('TF000001', 'T000001', 'F000001'),
('TF000002', 'T000001', 'F000003'),
('TF000003', 'T000002', 'F000004');
GO

-- Create View to combine trail data
CREATE VIEW CW2.vw_TrailDetails AS
SELECT 
    t.trail_id,
    t.trail_name,
    t.description,
    t.visibility,
    t.length,
    t.estimated_time,
    t.elevation_gain,
    t.created_at,
    t.updated_at,
    l.location_name,
    l.region,
    l.country,
    r.route_type,
    d.level as difficulty_level,
    u.username as created_by_name,
    u.email as creator_email,
    STRING_AGG(f.feature_name, ', ') as features
FROM CW2.Trail t
LEFT JOIN CW2.Location l ON t.location_id = l.location_id
LEFT JOIN CW2.Route r ON t.route_id = r.route_id
LEFT JOIN CW2.Difficulty d ON t.difficulty_id = d.difficulty_id
LEFT JOIN CW2.Users u ON t.created_by = u.user_id
LEFT JOIN CW2.Trail_Feature tf ON t.trail_id = tf.trail_id
LEFT JOIN CW2.Feature f ON tf.feature_id = f.feature_id
GROUP BY t.trail_id, t.trail_name, t.description, t.visibility, t.length, 
         t.estimated_time, t.elevation_gain, t.created_at, t.updated_at,
         l.location_name, l.region, l.country, r.route_type, d.level, 
         u.username, u.email;
GO

-- Test queries
SELECT * FROM CW2.Users;
SELECT * FROM CW2.Trail;
SELECT * FROM CW2.vw_TrailDetails;
SELECT * FROM CW2.Trail_Log;